<!DOCTYPE html>
<html>

<head>
	<title>Sanko.tv WebSocket Test</title>
</head>

<body>
	<div id="status">Disconnected</div>
	<div id="messages"></div>

	<script>
		const WS_URL = 'wss://chat.sanko.tv/ws?streamerAddress=0x5362c04666c92810f8fa72291a4ce60e51a128a2&uniqueId=testclient' + Math.random().toString(36).substring(7);

		let socket;
		let reconnectAttempts = 0;
		const MAX_RECONNECT_ATTEMPTS = 5;

		function updateStatus(message) {
			document.getElementById('status').textContent = message;
		}

		function addMessage(message) {
			const messagesDiv = document.getElementById('messages');
			messagesDiv.innerHTML += message + '<br>';
		}

		function connect() {
			updateStatus('Connecting...');
			socket = new WebSocket(WS_URL);

			socket.onopen = (event) => {
				console.log('Connected', event);
				updateStatus('Connected');
				reconnectAttempts = 0;

				// Send a "hello" message
				const helloMsg = {
					event: 'HELLO',
					data: {
						client: 'browser',
						version: '1.0.0',
						userAgent: navigator.userAgent
					}
				};
				socket.send(JSON.stringify(helloMsg));
			};

			socket.onmessage = (event) => {
				console.log('Received:', event.data);
				addMessage('Received: ' + event.data);
				try {
					const data = JSON.parse(event.data);
					if (data.event === 'PING') {
						socket.send(JSON.stringify({event: 'PONG'}));
					}
				} catch (error) {
					console.error('Error parsing message:', error);
				}
			};

			socket.onerror = (error) => {
				console.error('WebSocket error:', error);
				updateStatus('Error: ' + error.message);
			};

			socket.onclose = (event) => {
				console.log('Disconnected:', event);
				updateStatus('Disconnected');
				if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
					reconnectAttempts++;
					setTimeout(connect, 5000);
				}
			};
		}

		// Attempt to connect immediately
		connect();

		// Set up an interval to send a keep-alive message
		setInterval(() => {
			if (socket && socket.readyState === WebSocket.OPEN) {
				socket.send(JSON.stringify({event: 'KEEPALIVE'}));
			}
		}, 30000);
	</script>
</body>

</html>
